---
- name: MySQL Persistent Disk var
  when: pv_created is false
  set_fact:
    pv_created: true

- name: MySQL Persistent Disk line
  when: pv_created is false
  lineinfile:
      dest: inventory/gcp.yml
      regexp: 'pv_created:'
      line: '  pv_created: true'
      state: present

- name: MySQL PV
  shell: kubectl apply -f roles/mysql/tasks/pv.yml

- name: MySQL PVC
  shell: kubectl apply -f roles/mysql/tasks/mysql-pvc.yml 

#- name: MySQL Pod
#  shell: kubectl apply -f roles/mysql/tasks/mysql-pod.yml 

- name: MySQL Service
  shell: kubectl apply -f roles/mysql/tasks/mysql-service.yml

- name: MySQL Deployment
  shell: kubectl apply -f roles/mysql/tasks/mysql-deployment.yml

- name: Get MySQL Pod
  shell: kubectl get pod -l app=mysql -o jsonpath='{.items[0].metadata.name}'
  register: pod_name

- name: Set MySQL Pod
  lineinfile:
      dest: inventory/gcp.yml
      regexp: 'mysql_pod:'
      line: '  mysql_pod: {{ pod_name.stdout }}'
      state: present

- name: Set Var
  set_fact:
    mysql_pod: "{{ pod_name.stdout }}"